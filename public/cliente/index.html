<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin | Cardápio</title>
  <style>
    body{font-family:system-ui,Arial;margin:24px}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 120px 120px;gap:8px;align-items:center;margin-bottom:8px}
    .row.header{font-weight:700}
    input,select{padding:6px}
    img{width:72px;height:72px;object-fit:cover;border:1px solid #ddd;border-radius:8px}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:16px}
    button{padding:8px 12px;border:1px solid #333;background:#111;color:#fff;border-radius:8px;cursor:pointer}
    button.secondary{background:#fff;color:#111}
    .grid{margin-top:12px}
    .hint{color:#666;font-size:12px}
  </style>
</head>
<body>
  <h2>Admin do Cardápio</h2>
  <div class="toolbar">
    <input id="admToken" placeholder="ADMIN_TOKEN" style="width:280px"/>
    <button id="load">Atualizar lista</button>
    <span class="hint">Imagens: cole uma URL (ex: do Cloudinary/Imgur/Drive público).</span>
  </div>

  <div class="row header">
    <div>Nome</div><div>Preço (R$)</div><div>Categoria</div><div>URL da imagem</div><div>Imagem</div><div>Ações</div>
  </div>
  <div id="grid" class="grid"></div>

  <h3>Novo item</h3>
  <div class="row">
    <input id="nNome" placeholder="Ex: X-Burger"/>
    <input id="nPreco" type="number" step="0.01" placeholder="15.00"/>
    <input id="nCat" placeholder="Ex: Burgers"/>
    <input id="nImg" placeholder="https://..."/>
    <div><img id="nPrev" src="" alt=""></div>
    <button id="add">Adicionar</button>
  </div>

<script>
const moneyToCents = v => Math.round(parseFloat(v.replace(',','.'))*100);
const centsToMoney = c => (c/100).toFixed(2);

function token(){ return document.getElementById('admToken').value.trim(); }

async function fetchMenu(){
  const r = await fetch('/api/menu');
  return r.json();
}

async function createItem(data){
  const r = await fetch('/api/menu', {
    method:'POST',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+token()},
    body: JSON.stringify(data)
  });
  if(!r.ok) throw new Error('Erro ao criar');
  return r.json();
}

async function updateItem(id,data){
  const r = await fetch('/api/menu/'+id, {
    method:'PUT',
    headers:{'Content-Type':'application/json','Authorization':'Bearer '+token()},
    body: JSON.stringify(data)
  });
  if(!r.ok) throw new Error('Erro ao atualizar');
  return r.json();
}

async function deleteItem(id){
  const r = await fetch('/api/menu/'+id, {
    method:'DELETE',
    headers:{'Authorization':'Bearer '+token()}
  });
  if(!r.ok) throw new Error('Erro ao apagar');
}

function row(item){
  const div = document.createElement('div'); div.className='row';
  div.innerHTML = `
    <input value="${item.name||''}"/>
    <input value="${centsToMoney(item.price_cents||0)}"/>
    <input value="${item.category||''}"/>
    <input value="${item.image_url||''}"/>
    <div><img src="${item.image_url||''}" onerror="this.src='';"/></div>
    <div>
      <button class="secondary save">Salvar</button>
      <button class="secondary del">Apagar</button>
    </div>`;
  const [iNome,iPreco,iCat,iImg] = div.querySelectorAll('input');
  const img = div.querySelector('img');

  iImg.addEventListener('input',()=> img.src = iImg.value);

  div.querySelector('.save').onclick = async () => {
    await updateItem(item.id,{
      name: iNome.value,
      price_cents: moneyToCents(iPreco.value),
      category: iCat.value,
      image_url: iImg.value,
      available: true
    });
    load();
  };
  div.querySelector('.del').onclick = async () => {
    if(confirm('Apagar item?')){ await deleteItem(item.id); load(); }
  };
  return div;
}

async function load(){
  const list = await fetchMenu();
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  list.forEach(it => grid.appendChild(row(it)));
}

document.getElementById('load').onclick = load;

const nImg = document.getElementById('nImg');
nImg.addEventListener('input',()=> document.getElementById('nPrev').src = nImg.value);

document.getElementById('add').onclick = async ()=>{
  const name = document.getElementById('nNome').value;
  const price_cents = moneyToCents(document.getElementById('nPreco').value);
  const category = document.getElementById('nCat').value;
  const image_url = document.getElementById('nImg').value;
  await createItem({ name, price_cents, category, image_url, available:true });
  document.getElementById('nNome').value='';
  document.getElementById('nPreco').value='';
  document.getElementById('nCat').value='';
  document.getElementById('nImg').value='';
  document.getElementById('nPrev').src='';
  load();
};

// auto-load
load();
</script>
</body>
</html>
