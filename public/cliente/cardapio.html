<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cardápio</title>
  <link rel="stylesheet" href="../styles.css"/>
  <style>
    body { font-family: system-ui, Arial; margin: 16px; }
    header, footer { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .brand { font-weight:700; font-size:20px; }
    nav a { margin-right:12px; text-decoration:none; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(220px,1fr)); gap:16px; }
    .card { border:1px solid #e5e5e5; border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:8px; }
    .card img { width:100%; height:150px; object-fit:cover; border-radius:8px; }
    .card h3 { margin:0; font-size:18px; }
    .price { font-weight:700; }
    .actions { display:flex; gap:8px; }
    .btn { padding:10px 12px; border-radius:8px; border:1px solid #111; background:#111; color:#fff; cursor:pointer; }
    .btn.secondary { background:#fff; color:#111; }
    .category { margin:24px 0 8px; font-size:18px; font-weight:700; }
    .empty { padding:24px; text-align:center; color:#666; }
  </style>
</head>
<body>
  <header>
    <div class="brand"><span id="app-name">Carregando...</span></div>
    <nav>
      <a href="/">Início</a>
      <a href="/carrinho">Carrinho</a>
    </nav>
  </header>

  <main>
    <h1>Cardápio</h1>
    <div id="conteudo"></div>
  </main>

  <footer>
    <small>© <span id="year"></span> <span id="app-name-2">Carregando...</span></small>
  </footer>

  <script>
    // util
    const brl = v => (v/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    const groupBy = (arr, key) => arr.reduce((acc, cur)=>((acc[cur[key]||'Outros']=acc[cur[key]||'Outros']||[]).push(cur),acc),{});
    const byAvail = i => i.available !== false;

    // nome do app
    fetch('/config').then(r=>r.json()).then(c=>{
      document.querySelectorAll('#app-name,#app-name-2').forEach(el=> el.textContent = c.appName || 'Pitombo Lanches');
      document.title = (c.appName || 'Pitombo Lanches') + ' | Cardápio';
    }).catch(()=>{ document.querySelectorAll('#app-name,#app-name-2').forEach(el=> el.textContent='Pitombo Lanches'); });

    // ano
    document.getElementById('year').textContent = new Date().getFullYear();

    // carrinho
    function getCart(){ try{ return JSON.parse(localStorage.getItem('carrinho')||'[]'); }catch{ return []; } }
    function setCart(c){ localStorage.setItem('carrinho', JSON.stringify(c)); }
    function addToCart(item){
      const c = getCart();
      c.push({ item: item.name, preco: item.price_cents/100, image: item.image_url });
      setCart(c);
      alert(item.name + ' adicionado ao carrinho!');
    }

    // render
    function renderList(lista){
      const root = document.getElementById('conteudo');
      if(!lista || lista.length===0){
        root.innerHTML = '<div class="empty">Nenhum item cadastrado no momento.</div>';
        return;
      }
      const grupos = groupBy(lista.filter(byAvail), 'category');
      root.innerHTML = '';
      Object.keys(grupos).forEach(cat=>{
        const h = document.createElement('div');
        h.className='category';
        h.textContent = cat;
        root.appendChild(h);

        const grid = document.createElement('div');
        grid.className='grid';
        grupos[cat].forEach(it=>{
          const card = document.createElement('div');
          card.className='card';
          card.innerHTML = `
            <img src="${it.image_url||''}" alt="${it.name||''}" onerror="this.style.display='none'">
            <h3>${it.name||''}</h3>
            <div class="price">${brl(it.price_cents||0)}</div>
            <div class="actions">
              <button class="btn" data-id="${it.id}">Adicionar</button>
              <a class="btn secondary" href="/carrinho">Ver carrinho</a>
            </div>
          `;
          card.querySelector('button.btn').onclick = ()=> addToCart(it);
          grid.appendChild(card);
        });
        root.appendChild(grid);
      });
    }

    // carregar do backend
    fetch('/api/menu')
      .then(r=>r.json())
      .then(renderList)
      .catch(err=>{
        console.error(err);
        renderList([]);
      });
  </script>
</body>
</html>
