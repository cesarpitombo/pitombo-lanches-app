<script>
  let phone = ''; // virá do /api/config
  let carrinho = [];

  async function carregarConfig() {
    const cfg = await fetch('/api/config').then(r => r.json());
    phone = (cfg.phone || '').replace(/\D/g,''); // só dígitos
  }

  async function carregarCardapio() {
    const resposta = await fetch("/cardapio");
    const produtos = await resposta.json();
    const container = document.getElementById("menu");
    container.innerHTML = "";

    produtos.forEach(p => {
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <img src="${p.imagem}" alt="${p.nome}">
        <h3>${p.nome}</h3>
        <p>R$ ${parseFloat(p.preco).toFixed(2).replace('.', ',')}</p>
        <button onclick='adicionarCarrinho(${JSON.stringify(p)})'>Adicionar</button>
      `;
      container.appendChild(div);
    });
  }

  function adicionarCarrinho(produto) {
    carrinho.push(produto);
    atualizarCarrinho();
  }

  function atualizarCarrinho() {
    const itensDiv = document.getElementById("itens");
    const total = carrinho.reduce((acc, item) => acc + parseFloat(item.preco), 0);
    itensDiv.innerHTML = carrinho.map(p => `<p>${p.nome} - R$ ${parseFloat(p.preco).toFixed(2).replace('.', ',')}</p>`).join("");
    document.getElementById("total").innerHTML = `<strong>Total: R$ ${total.toFixed(2).replace('.', ',')}</strong>`;
  }

  function enviarWhatsApp() {
    if (!phone) { alert('Telefone do WhatsApp não configurado.'); return; }
    if (carrinho.length === 0) { alert('Carrinho vazio.'); return; }

    const linhas = carrinho.map(p => `- ${p.nome} (R$ ${parseFloat(p.preco).toFixed(2).replace('.', ',')})`);
    const total = carrinho.reduce((acc, p) => acc + parseFloat(p.preco), 0);
    const msg = `Olá! Quero fazer um pedido:%0A${linhas.join('%0A')}%0A%0ATotal: R$ ${total.toFixed(2).replace('.', ',')}`;

    const url = `https://wa.me/${phone}?text=${msg}`;
    window.open(url, '_blank');
  }

  async function start() {
    await carregarConfig();
    await carregarCardapio();
  }

  start();
</script>
